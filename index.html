<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="css/bootstrap.min.css" rel="stylesheet">
	<link href="js/jquery-ui-1.11.4.custom/jquery-ui.css" rel="stylesheet">

    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

	<style>
		.chip {display: inline-block; padding:5px 10px 5px 10px; cursor: pointer;}
		#bank .chip {margin-bottom: 2px}
		.bulk {padding:20px; display: inline-block;}

	</style>	


  </head>
  <body>
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="js/bootstrap.min.js"></script>
	<script src="js/jquery-ui-1.11.4.custom/jquery-ui.js"></script>
	<script src="js/jsrender.js"></script>

<!--Prepare chips-->
	<script type="text/javascript">
                var bulk = jQuery("<div class=\"ui-widget ui-widget-content ui-corner-all bulk\"><span class=\"draggable\"></span></div>");

		$(function(){

			var chips = [
				{litera:"A", score:1, num:10},
				{litera:"Б", score:3, num:3},
				{litera:"В", score:2, num:5},
				{litera:"Г", score:3, num:3},
				{litera:"Д", score:2, num:5},
				{litera:"Е", score:1, num:9},
				{litera:"Ж", score:5, num:2},
				{litera:"З", score:5, num:2},
				{litera:"И", score:1, num:8},
				{litera:"Й", score:3, num:4},
				{litera:"К", score:2, num:6},
				{litera:"Л", score:2, num:4},
				{litera:"М", score:2, num:5},
				{litera:"Н", score:1, num:8},
				{litera:"О", score:1, num:10},
				{litera:"П", score:2, num:6},
				{litera:"Р", score:2, num:6},
				{litera:"С", score:2, num:6},
				{litera:"Т", score:2, num:5},
				{litera:"У", score:3, num:3},
				{litera:"Ф", score:10, num:1},
				{litera:"Х", score:5, num:2},
				{litera:"Ц", score:10, num:1},
				{litera:"Ч", score:5, num:2},
				{litera:"Ш", score:10, num:1},
				{litera:"Щ", score:10, num:1},
				{litera:"Ъ", score:10, num:1},
				{litera:"Ы", score:5, num:2},
				{litera:"Ь", score:5, num:2},
				{litera:"Э", score:10, num:1},
				{litera:"Ю", score:10, num:1},
				{litera:"Я", score:3, num:3},
				{litera:"*", score:0, num:3}

			];

			chips.sort(function(x,y){
				return y.num - x.num;
			});

			var randomChipsForBank = [];
			for(var i in chips){
				addAdditionChips(randomChipsForBank, chips[i]);
				randomizeArray(randomChipsForBank);
			}
		
			fillBank(randomChipsForBank);
			saveHelperData(randomChipsForBank);
		});

		function saveHelperData (data) {
			for(var i in data){
				$("#scores").data(data[i].id, data[i]);
			}
		}
		function addAdditionChips(array, chip){
			for(var i = chip.num; i >0; i--){
				var newChip = Object.create(chip);
				newChip.id = "id_" + chip.litera.charCodeAt() + "_" + i;
				array.push(newChip);
			}
			
			return array;
		}
		function randomizeArray(array){
			array.sort(function(){
				return Math.random() - 0.6;
			});
		}
		function fillBank(chips){
			//var tmpl = $.templates("#chip-tmpl").render(chips);
			//$("#bank").append(tmpl);
			$("#bank").data("chips",chips);
			for(var i=0; i<chips.length; i++){
				$("#bank").append(bulk.clone());
			}
		}
		function signChips(chipData){
			var chips = $.templates("#chip-tmpl").render(chipData);
			return jQuery(chips);
		}
	</script>

<!--Template for Chip-->
	<script id="chip-tmpl" type="text/x-jsrender">
		<div id="{{:id}}" class="ui-widget ui-widget-content ui-corner-all chip">
			<span class="draggable">{{:litera}}<sub>{{:score}}</sub></span>
		</div>
	</script>
<!-- Template for score statistic -->
	<script id="score-tmpl" type="text/x-jsrender">
		<ul class="list-unstyled">
			<li><code>{{:user.name}}:</code></li>
			<ul>
			{{for stat}}
				<li>
					<small><abbr title="{{:wordAbbr}}">{{:wordReduced}}</abbr>&nbsp;<kbd>{{:score}}</kbd></small>
				</li>
			{{/for}}
			</ul>
		</ul>
	</script>

<!--Draggable and Droppable part-->
	<script type="text/javascript">
		$(function(){
			
			initDraggable();

			$(".board td").droppable({
				drop: function( event, ui ) {
					ui.helper.addClass("boarded");
					setDataBoard(ui, $(this));
					$(".user-set").removeData(ui.helper.attr("id"));
					resetDroppable(ui);
				}
			});

			$(".user-set").droppable({
				drop: function(event, ui){
					ui.helper.removeClass("boarded");
					setUserSetByBulk(ui.helper);
					$(".board").removeData( ui.helper.attr("id"));
                    resetDroppable(ui);
				}
			});
		});

		function initDraggable(){
			$(".draggable").parent().draggable({
				cursor: "move",
				snap:".board td",
				revert:"invalid"
			});
		}

		function getObjectKeys(obj){
			return Object.keys(obj);
		}

		function resetDroppable(JQdraggable){
			$(".board td").droppable("enable");
			var droppablesOnBoard = $(".board").data();
			for(var i in droppablesOnBoard){
				droppablesOnBoard[i].droppable("disable");
			}

			resetUserSet();
		}

		function resetUserSet(){
			var notBoarded = $(".user-set").children(".chip:not(.boarded)");
			if(notBoarded.size() < 7){
				setDroppableUserSet("enable");
			} else {
				setDroppableUserSet("disable");
			}
			toggleUserSetFillingPossibility();
		}

		function setDroppableUserSet(state){
			var userSet = $(".user-set");
			if(state === "enable"){
				userSet.removeClass("alert-success");
				userSet.addClass("alert-danger");
			} else {
				userSet.removeClass("alert-danger");
				userSet.addClass("alert-success");
			}
		}

		function setDataBoard(JQdraggable, JQdroppable){
			var tdId =JQdraggable.helper.attr("id");
			$(".board").data(tdId, JQdroppable);
		}

		function setUserSetByBulk(JQchips){
			if(!JQchips.hasClass("bulk")) return;

			var JQbulk = JQchips;
            JQbulk.each(function(){
				clearPosition($(this));
				$(this).addClass("invisible");
				$(this).draggable( "disable" );
			});
			
			JQchips = getRandomChips(JQchips.size());
			var userSet = $(".user-set");
			JQchips.each(function(index){
				userSet.data($(this).attr("id"),$(this));
				userSet.append($(this));
			});
			
			initDraggable();
		}
// Return jQuery objects
		function getRandomChips(num){
			var chips = $("#bank").data("chips");
			return signChips(chips.splice(0,num));
		}

		function replaceChip(JQchip){
			JQchip.replaceWith(bulk.clone());
			//JQchip.css({"visibility":"hidden"});
		}

		function log(str){
			console.log(str);
		}

		function toggleUserSetFillingPossibility(){
			var bankBulks = $("#bank").children(".bulk:not(.invisible)")
			if($(".user-set").children(".chip").size() < 7){
				bankBulks.draggable("option","scope", "default");
				$("#fillUserSetBtn").removeAttr("disabled");
			}else{
				bankBulks.draggable("option","scope","bank");
				$("#fillUserSetBtn").attr("disabled", "disabled");
			}
			
		}

		function clearPosition (JQobj) {
			JQobj.css({"left":"0px", "top":"0px"});	
		}

		function saveWord (literaIds) {
			var litera, score = 0, word = [] , data = {};
			for (var i = 0; i < literaIds.length; i++) {
				litera = $("#scores").data(literaIds[i]);
				word.push(litera.litera);
				score += litera.score;
			};

			var userStat = getUserStat(getUser.login);
			if(!userStat.stat) {
				userStat.stat = [];
				userStat.user = getUser();
			}
			data.num = (userStat.stat.length == 0) ? 1 : userStat.stat[userStat.stat.length - 1].num + 1;
			data.word = word.join("");
			data.wordAbbr = data.word;
			data.wordReduced = data.word;
			data.score = score;
			userStat.stat.push(data);

			var html = $.templates("#score-tmpl").render(userStat);
			$("#scores .panel-body ul").remove();
			$("#scores .panel-body").append(jQuery(html));

		}

		function getUser () {
			return {name:"Алексей", login:"alex", email:"alex@mail.ru"};
		}

		function getUserStat (login) {
			if (!$("#scores").data("users-stat")){
				$("#scores").data("users-stat",{login:{}});
			}
			return $("#scores").data("users-stat").login;
		}
	</script>

<!--Button events-->
<script type="text/javascript">
	$(function(){
		$("#fillUserSetBtn").click(function(){
			var userSet = $(".user-set");
			var countUserSetChips = userSet.children(".chip").size();
			if(countUserSetChips < 7){
				var bulks = $("#bank").children(".bulk:not(.invisible)").toArray();
				randomizeArray(bulks);
				var randBulks = $(bulks.slice(0, (7 - countUserSetChips)));
				setUserSetByBulk(randBulks);
				resetUserSet();
			}
		});

		$("#nextPlayerBtn").click(function(){
			clearPosition($(".user-set .chip"));
			var letterIds = getObjectKeys($(".board").data());
			$(".user-set .boarded").each(function(index) {
				var droppable = $(".board").data( $(this).attr("id"));
				// $(this).append("<sup>" + $(this).attr("id") + "</sup>");
				droppable.append($(this));
				
				$(this).removeClass("boarded");
				$(this).draggable( "disable" );
				$(this).children(".draggable").removeClass("draggable");

				$(".board").removeData( $(this).attr("id"));
			});

			toggleUserSetFillingPossibility();
			saveWord(letterIds);
		});
	});
</script>


<div class="container-fluid">
	<div class="row">
		<div class="col-xs-8 col-xs-offset-2">
                        <div class="panel panel-default">
				<div class="panel-body"></div>
				<div class="panel-footer text-center">Top</div>
			</div>

		</div>
	</div>

	<div class="row">
		<div class="col-md-2">
			<div id="scores" class="panel panel-default">
				<div class="panel-heading text-center">Статистика</div>
				<div class="panel-body">
					<ul class="list-unstyled">
						<li><code>Имя игрока:</code></li>
						<ul>
							<li>
								<small><abbr title="груша">груша</abbr>&nbsp;<kbd>9</kbd></small>
							</li>
						</ul>
					</ul>
				</div>
			</div>
		</div>
		<div class="col-md-8">
			<div class="jumbotron text-center bg-warning">
				<table class="table table-bordered table-striped board">
<!--Header -->
					<tr>
						<td></td>
						<td><span class="badge">&nbsp;1</span></td>
						<td><span class="badge">&nbsp;2</span></td>
						<td><span class="badge">&nbsp;3</span></td>
						<td><span class="badge">&nbsp;4</span></td>
						<td><span class="badge">&nbsp;5</span></td>
						<td><span class="badge">&nbsp;6</span></td>
						<td><span class="badge">&nbsp;7</span></td>
						<td><span class="badge">&nbsp;8</span></td>
						<td><span class="badge">&nbsp;9</span></td>
						<td><span class="badge">10</span></td>
						<td><span class="badge">11</span></td>
						<td><span class="badge">12</span></td>
						<td><span class="badge">13</span></td>
						<td><span class="badge">14</span></td>
						<td><span class="badge">15</span></td>
					</tr>
<!--A: 1-15 -->
					<tr>
						<td><span class="badge">A</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--B: 1-15 -->
					<tr>
						<td><span class="badge">B</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--C: 1-15 -->
					<tr>
						<td><span class="badge">C</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--D: 1-15 -->
					<tr>
						<td><span class="badge">D</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--F: 1-15 -->
					<tr>
						<td><span class="badge">F</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--G: 1-15 -->
					<tr>
						<td><span class="badge">G</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--H: 1-15 -->
					<tr>
						<td><span class="badge">H</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--I: 1-15 -->
					<tr>
						<td><span class="badge">I</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--J: 1-15 -->
					<tr>
						<td><span class="badge">J</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>

<!--K: 1-15 -->
					<tr>
						<td><span class="badge">K</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>

<!--L: 1-15 -->
					<tr>
						<td><span class="badge">L</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>
<!--M: 1-15 -->                                                           
					<tr>
						<td><span class="badge">M</span></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
					</tr>


				</table>
			</div>
		</div>
		<div class="col-md-2">
			<div class="panel panel-default">
				<div class="panel-heading text-center">Чат</div>
				<div class="panel-body"></div>

			</div>
		</div>
	</div>


	<div class="row">
		<div class="col-xs-8 col-xs-offset-2">
                        <div class="panel panel-default">
				<div class="panel-heading">
<!--chips-->                                    
	                        	<div class="row">
						<div class="col-xs-8">
							<div class="user-set alert alert-danger">&nbsp;</div>
						</div>
						<div class="col-xs-4">
<div class="btn-group-sm">
  <button id="fillUserSetBtn" type="button" class="btn btn-default">Набрать фишки</button>
  <button id="nextPlayerBtn" type="button" class="btn btn-default">Передать ход</button>
</div>						</div>
					</div>
				</div>
				<div id="bank" class="panel-body" >

				</div>             
			</div>
		</div>
	</div>

</div>

  </body>
</html>
